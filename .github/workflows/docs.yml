# =============================================================================
# DOCUMENTATION BUILD AND DEPLOYMENT WORKFLOW
# =============================================================================
# This GitHub Actions workflow builds Sphinx documentation and deploys it to GitHub Pages.
#
# Triggered on:
# - Manual workflow dispatch only (run from GitHub Actions UI)
#
# The workflow:
# 1. Cleans any previous build artifacts
# 2. Builds Sphinx documentation from source code and docstrings
# 3. Generates API documentation automatically
# 4. Deploys to GitHub Pages for public access

name: Documentation

# =============================================================================
# WORKFLOW TRIGGERS
# =============================================================================
on:
  # Only allow manual triggering from GitHub Actions UI
  workflow_dispatch:
    inputs:
      deploy_to_pages:
        description: 'Deploy to GitHub Pages after building'
        required: false
        type: boolean
        default: true

# =============================================================================
# WORKFLOW-LEVEL ENVIRONMENT VARIABLES
# =============================================================================
env:
  PYTHON_VERSION: "3.11"
  POETRY_VERSION: "1.8.3"

# =============================================================================
# WORKFLOW PERMISSIONS
# =============================================================================
permissions:
  contents: read
  pages: write
  id-token: write

# Ensure only one deployment runs at a time
concurrency:
  group: "pages"
  cancel-in-progress: false

# =============================================================================
# JOB DEFINITIONS
# =============================================================================
jobs:
  # ===========================================================================
  # BUILD DOCUMENTATION
  # ===========================================================================
  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached dependencies
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-docs-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        run: poetry install --no-interaction --with docs

      - name: Clean previous builds
        run: |
          echo "ðŸ§¹ Cleaning previous documentation builds..."
          rm -rf docs/build
          rm -rf docs/source/api
          echo "âœ… Clean complete"

      - name: Set up documentation environment
        run: |
          echo "ðŸ“š Setting up documentation environment..."

          # Create necessary directories
          mkdir -p docs/source/_static
          mkdir -p docs/source/api

          # Generate API documentation from source code
          poetry run sphinx-apidoc \
            -o docs/source/api \
            src/knit_script/ \
            --force \
            --module-first \
            --separate \
            --no-toc

          echo "âœ… Environment setup complete"

      - name: Build Sphinx documentation
        run: |
          echo "ðŸ”¨ Building Sphinx documentation..."

          # Build with clean environment flags
          poetry run sphinx-build \
            -a \
            -E \
            -b html \
            docs/source/ \
            docs/build/html/ \
            -W \
            --keep-going

          # Create .nojekyll file for GitHub Pages
          touch docs/build/html/.nojekyll

          echo "âœ… Documentation build complete"

      - name: Validate documentation
        run: |
          echo "ðŸ” Validating documentation build..."

          if [ ! -f "docs/build/html/index.html" ]; then
            echo "âŒ index.html not found in build output"
            exit 1
          fi

          echo "âœ… Documentation validation passed"

          # Display build summary
          echo ""
          echo "ðŸ“Š Documentation build summary:"
          echo "  Total HTML files: $(find docs/build/html -name "*.html" | wc -l)"
          echo "  API files: $(find docs/build/html/api -name "*.html" 2>/dev/null | wc -l || echo "0")"
          echo "  Build size: $(du -sh docs/build/html | cut -f1)"

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: documentation-html
          path: docs/build/html/
          retention-days: 30

      - name: Setup Pages
        if: inputs.deploy_to_pages
        uses: actions/configure-pages@v5

      - name: Upload to GitHub Pages
        if: inputs.deploy_to_pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/build/html/

  # ===========================================================================
  # DEPLOY TO GITHUB PAGES
  # ===========================================================================
  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-docs
    if: inputs.deploy_to_pages

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Post deployment summary
        run: |
          echo "âœ… Documentation deployed successfully!"
          echo "ðŸ”— Documentation URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ðŸ“„ Documentation will be available within a few minutes"

# =============================================================================
# HOW TO USE THIS WORKFLOW
# =============================================================================
#
# To manually trigger this workflow:
# 1. Go to your repository on GitHub
# 2. Click "Actions" tab
# 3. Select "Documentation" workflow from the left sidebar
# 4. Click "Run workflow" button (top right)
# 5. Choose whether to deploy to GitHub Pages (default: yes)
# 6. Click "Run workflow" to start
#
# The workflow will:
# - Clean all previous builds
# - Build fresh documentation
# - Validate the build
# - Optionally deploy to GitHub Pages
# - Upload artifacts for download (available for 30 days)
#
# =============================================================================
# TROUBLESHOOTING
# =============================================================================
#
# If the build fails:
# 1. Check the "Build Sphinx documentation" step for actual errors
# 2. Ignore warnings about "overwriting data" - these are harmless
# 3. Look for WARNING or ERROR messages about your docstrings
# 4. Download the artifacts to inspect the built HTML locally
#
# Common issues:
# - Protocol duplicate warnings: Use attribute docstrings, not class docstring Attributes section
# - Import errors: Ensure all dependencies are in the [tool.poetry.group.docs.dependencies]
# - Missing files: Check that docs/source/conf.py and docs/source/index.rst exist
